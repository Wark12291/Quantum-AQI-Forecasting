import streamlit as st
import requests
from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.lib.pagesizes import letter
from reportlab.lib import colors
from io import BytesIO

def run():

    st.markdown("<h2 class='title-glow'>üì° Real-Time Air Quality ‚Äì Tirupati</h2>", unsafe_allow_html=True)
    st.markdown("<p class='subtitle'>Live AQI data from WAQI API</p>", unsafe_allow_html=True)

    CITY = "tirupati"
    TOKEN = "demo"

    url = f"https://api.waqi.info/feed/{CITY}/?token={TOKEN}"

    try:
        # -------------------------------------------------------
        # API CALL
        # -------------------------------------------------------
        response = requests.get(url, timeout=10)
        data = response.json()

        if data["status"] != "ok":
            st.error("‚ùå AQI data unavailable. Try again later.")
            return

        aqi = data["data"]["aqi"]
        dominent = data["data"].get("dominentpol", "N/A")
        iaqi = data["data"].get("iaqi", {})

        # MAIN AQI CARD
        st.markdown(f"""
            <div class='card'>
                <h2>üå¨ Current AQI: <span style='color:#00eaff'>{aqi}</span></h2>
                <p>Dominant Pollutant: <b>{dominent.upper()}</b></p>
            </div>
        """, unsafe_allow_html=True)

        # -------------------------------------------------------
        # POLLUTANTS
        # -------------------------------------------------------
        POLLUTANT_NAMES = {
            "PM25": "Fine Particulate Matter (PM2.5)",
            "PM10": "Coarse Particulate Matter (PM10)",
            "O3": "Ozone (O‚ÇÉ)",
            "NO2": "Nitrogen Dioxide (NO‚ÇÇ)",
            "SO2": "Sulfur Dioxide (SO‚ÇÇ)",
            "CO": "Carbon Monoxide (CO)",
            "T": "Temperature (T)",
            "H": "Humidity (H)",
            "P": "Air Pressure (P)",
            "DEW": "Dew Point (DEW)",
            "W": "Wind Speed (W)"
        }

        pollutants = []
        for pol, val in iaqi.items():
            code = pol.upper()
            pollutants.append({
                "FullName": POLLUTANT_NAMES.get(code, code),
                "Value": val.get("v", "N/A")
            })

        cols = st.columns(3)
        for i, item in enumerate(pollutants):
            html = f"""
                <div class='card' style="margin:25px; padding:25px; border-radius:20px;">
                    <h4 style='font-size:20px;'>{item['FullName']}</h4>
                    <p style='font-size:17px;'>Value: <b>{item['Value']}</b></p>
                </div>
            """
            cols[i % 3].markdown(html, unsafe_allow_html=True)

        # -------------------------------------------------------
        # PDF CREATION
        # -------------------------------------------------------
        buffer = BytesIO()
        doc = SimpleDocTemplate(buffer, pagesize=letter)
        styles = getSampleStyleSheet()

        neon_title = ParagraphStyle(
            'NeonTitle', parent=styles['Title'],
            textColor=colors.HexColor("#00bfff"), fontSize=28, alignment=1
        )

        section_head = ParagraphStyle(
            'SectionHead', parent=styles['Heading2'],
            textColor=colors.HexColor("#0099ff"), fontSize=18
        )

        story = []
        story.append(Paragraph("Quantum AQI Forecast ‚Äì Tirupati", neon_title))
        story.append(Spacer(1, 20))

        story.append(Paragraph(f"<b>Current AQI:</b> <font color='#00aaff'>{aqi}</font>", section_head))
        story.append(Paragraph(f"<b>Dominant Pollutant:</b> {dominent.upper()}", styles["Normal"]))
        story.append(Spacer(1, 15))

        story.append(Paragraph("<b>Pollutant Measurements</b>", section_head))
        story.append(Spacer(1, 10))

        table_data = [["Pollutant", "Value"]]
        for item in pollutants:
            table_data.append([item["FullName"], str(item["Value"])])

        table = Table(table_data, colWidths=[260, 100])
        table.setStyle(TableStyle([
            ("BACKGROUND", (0,0), (-1,0), colors.HexColor("#00bfff")),
            ("TEXTCOLOR", (0,0), (-1,0), colors.white),
            ("BACKGROUND", (0,1), (-1,-1), colors.HexColor("#e6f7ff")),
            ("GRID", (0,0), (-1,-1), 0.5, colors.HexColor("#00bfff"))
        ]))

        story.append(table)
        doc.build(story)
        pdf_data = buffer.getvalue()

        # -------------------------------------------------------
        # CSS + DOWNLOAD BUTTON
        # -------------------------------------------------------
        st.markdown("""
            <style>
                .download-btn {
                    background: linear-gradient(90deg, #00eaff, #008cff);
                    padding: 12px 25px;
                    border-radius: 12px;
                    color: white !important;
                    font-size: 18px;
                    font-weight: bold;
                    cursor: pointer;
                    box-shadow: 0px 0px 12px #00bfff;
                    transition: 0.3s;
                }
                .download-btn:hover {
                    box-shadow: 0px 0px 25px #00eaff;
                    transform: scale(1.03);
                }
            </style>
        """, unsafe_allow_html=True)

        st.download_button(
            label="üìÑ Download",
            data=pdf_data,
            file_name=f"{CITY}_AQI_Report.pdf",
            mime="application/pdf",
            help="Download the premium AQI Report",
            key="premium_pdf"
        )

    except Exception as e:
        st.error(f"‚ùå Error fetching AQI: {str(e)}")
